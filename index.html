<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1E3A5F">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Pup Pad</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0F1D3A;touch-action:none;user-select:none;-webkit-user-select:none}
@keyframes sweep{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes pawFlash{0%{opacity:0.9}4%{opacity:0.7}12%{opacity:0.3}20%{opacity:0.08}25%,100%{opacity:0}}
@keyframes fadeUp{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes pfloat{0%,100%{transform:translateY(0) rotate(-10deg)}50%{transform:translateY(-10px) rotate(5deg)}}
@keyframes pawPop{0%{transform:translate(-50%,-50%) scale(0.1);opacity:0.9}30%{transform:translate(-50%,-50%) scale(1.3);opacity:0.8}50%{transform:translate(-50%,-50%) scale(1.5);opacity:0.5}100%{transform:translate(-50%,-50%) scale(2.2);opacity:0}}
@keyframes xGrow{0%{transform:translate(-50%,-50%) scale(0.15);opacity:0}5%{transform:translate(-50%,-50%) scale(0.25);opacity:1}90%{transform:translate(-50%,-50%) scale(1.54);opacity:0.9}100%{transform:translate(-50%,-50%) scale(1.54);opacity:0}}
@keyframes lockPulse{0%,100%{opacity:0.5}50%{opacity:1}}
</style>
</head>
<body>
<div id="app"></div>
<script>
/* === SVG Helpers === */
function pawSVG(size, color) {
  return '<svg width="'+size+'" height="'+size+'" viewBox="0 0 100 100" fill="'+color+'"><ellipse cx="50" cy="68" rx="20" ry="18"/><ellipse cx="24" cy="44" rx="9" ry="11" transform="rotate(-20 24 44)"/><ellipse cx="76" cy="44" rx="9" ry="11" transform="rotate(20 76 44)"/><ellipse cx="40" cy="26" rx="8" ry="11" transform="rotate(-8 40 26)"/><ellipse cx="60" cy="26" rx="8" ry="11" transform="rotate(8 60 26)"/></svg>';
}
function xSVG(size, color) {
  return '<svg width="'+size+'" height="'+size+'" viewBox="0 0 100 100" fill="none" stroke="'+color+'" stroke-linecap="round" stroke-linejoin="round"><line x1="15" y1="15" x2="85" y2="85" stroke-width="10"/><line x1="85" y1="15" x2="15" y2="85" stroke-width="10"/></svg>';
}
function lockSVG(size, color, locked) {
  var body = locked ? '<rect x="3" y="11" width="18" height="11" rx="2" fill="'+color+'"/><path d="M7 11V7a5 5 0 0 1 10 0v4" fill="none" stroke="'+color+'" stroke-width="2" stroke-linecap="round"/>' : '<rect x="3" y="11" width="18" height="11" rx="2" fill="none" stroke="'+color+'" stroke-width="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1" fill="none" stroke="'+color+'" stroke-width="2" stroke-linecap="round"/>';
  return '<svg width="'+size+'" height="'+size+'" viewBox="0 0 24 24">'+body+'</svg>';
}

/* === Audio === */
var audioCtx = null;
function getAudioCtx() {
  if (!audioCtx || audioCtx.state === 'closed') audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
function doSound(type) {
  try {
    var c = getAudioCtx();
    function mk(freq, dur, wave, delay, vol) {
      var o = c.createOscillator(), g = c.createGain();
      o.type = wave; o.frequency.value = freq;
      var t = c.currentTime + (delay || 0), v = vol || 0.12;
      g.gain.setValueAtTime(v, t); g.gain.exponentialRampToValueAtTime(0.001, t + dur);
      o.connect(g).connect(c.destination); o.start(t); o.stop(t + dur);
    }
    function sw(f1, f2, dur, wave, delay, vol) {
      var o = c.createOscillator(), g = c.createGain();
      o.type = wave; var t = c.currentTime + (delay || 0), v = vol || 0.12;
      o.frequency.setValueAtTime(f1, t); o.frequency.linearRampToValueAtTime(f2, t + dur);
      g.gain.setValueAtTime(v, t); g.gain.exponentialRampToValueAtTime(0.001, t + dur);
      o.connect(g).connect(c.destination); o.start(t); o.stop(t + dur);
    }
    var S = {
      ping:function(){mk(880,.08,'sine',0,.15);mk(1320,.12,'sine',.08,.12);mk(1760,.2,'sine',.16,.08)},
      chime:function(){mk(392,.3,'sine',0,.1);mk(523,.3,'sine',.1,.1);mk(659,.3,'sine',.2,.1);mk(784,.4,'sine',.3,.12)},
      scan:function(){sw(200,1800,.4,'sawtooth',0,.08);mk(1800,.15,'sine',.35,.06);mk(2200,.1,'sine',.42,.04)},
      alert:function(){mk(880,.08,'square',0,.1);mk(660,.08,'square',.1,.1);mk(880,.08,'square',.2,.1);mk(660,.08,'square',.3,.1);mk(880,.12,'square',.4,.08)},
      tap:function(){mk(3000,.02,'square',0,.15);mk(800,.08,'triangle',.02,.1);mk(1200,.15,'sine',.03,.06)},
      twinkle:function(){mk(1568,.12,'sine',0,.1);mk(1319,.12,'sine',.08,.1);mk(1047,.12,'sine',.16,.1);mk(1319,.12,'sine',.24,.08);mk(1568,.2,'sine',.32,.06)},
      blip:function(){mk(4000,.015,'square',0,.15);mk(2000,.03,'sine',.02,.1);sw(1500,800,.08,'sine',.05,.08);mk(1000,.06,'triangle',.12,.05)},
      powerUp:function(){sw(80,400,.3,'sawtooth',0,.08);sw(400,1200,.2,'sine',.2,.1);mk(1200,.15,'sine',.35,.12);mk(1600,.1,'sine',.4,.08);mk(2400,.3,'sine',.45,.06)},
      lock:function(){mk(600,.06,'sine',0,.1);mk(400,.12,'sine',.06,.1)},
      unlock:function(){mk(400,.06,'sine',0,.1);mk(600,.12,'sine',.06,.1)},
      keyTap:function(){mk(1800,.03,'sine',0,.08)},
      error:function(){mk(300,.08,'square',0,.1);mk(200,.15,'square',.1,.1)}
    };
    if(S[type])S[type]();
  } catch(e){}
}

/* === Button Data === */
var BTNS_LEFT=[
  {id:0,label:'Comms',color:'#3B82F6',glow:'#60A5FA',emoji:'\uD83D\uDCE1',sound:'ping',msg:'Signal locked!',bg:'#1e3a8a'},
  {id:1,label:'Map',color:'#10B981',glow:'#34D399',emoji:'\uD83D\uDDFA',sound:'chime',msg:'Coordinates loaded!',bg:'#064e3b'},
  {id:2,label:'Scanner',color:'#F59E0B',glow:'#FBBF24',emoji:'\uD83D\uDD0D',sound:'scan',msg:'Scanning area...',bg:'#78350f'},
  {id:3,label:'Alert',color:'#EF4444',glow:'#F87171',emoji:'\uD83D\uDEA8',sound:'alert',msg:'Alert sent!',bg:'#7f1d1d'}
];
var BTNS_RIGHT=[
  {id:4,label:'Tools',color:'#8B5CF6',glow:'#A78BFA',emoji:'\uD83D\uDD27',sound:'tap',msg:'Toolkit ready!',bg:'#4c1d95'},
  {id:5,label:'Weather',color:'#06B6D4',glow:'#22D3EE',emoji:'\u26C5',sound:'twinkle',msg:'Clear skies!',bg:'#164e63'},
  {id:6,label:'Camera',color:'#EC4899',glow:'#F472B6',emoji:'\uD83D\uDCF7',sound:'blip',msg:'Snapshot captured!',bg:'#831843'},
  {id:7,label:'Power',color:'#F97316',glow:'#FB923C',emoji:'\u26A1',sound:'powerUp',msg:'Systems charged!',bg:'#7c2d12'}
];
var BLIPS=[
  {top:'28%',left:'60%',size:10,delay:4.35},
  {top:'42%',left:'24%',size:9,delay:2.74},
  {top:'68%',left:'65%',size:10,delay:0.70},
  {top:'55%',left:'36%',size:8,delay:2.23}
];

/* === State === */
var state = {active:null, pid:-1, pop:'', isLocked:false, storedPin:null};
var activeTimer = null;
var tpId = 0, xmId = 0;
var longPressTimer = null, longPressPos = null, didLongPress = false;
var LONG_PRESS_MS = 1000;

/* === Build Sweep Lines HTML === */
function buildSweepLines() {
  var h = '';
  for (var i = 0; i < 50; i++) {
    var angle = -(i + 1) * 1.5;
    var opacity = (0.3 * Math.pow(1 - (i / 50), 1.8)).toFixed(4);
    h += '<div style="position:absolute;top:50%;left:50%;width:70%;height:6px;margin-top:-3px;transform-origin:left center;transform:rotate('+angle+'deg);background:var(--sc);opacity:'+opacity+'"></div>';
  }
  return h;
}

/* === Build Button HTML === */
function btnHTML(btn) {
  var isOn = state.pid === btn.id;
  return '<div class="pad-btn" data-id="'+btn.id+'" style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 6px 5px;border-radius:12px;cursor:pointer;background:'+(isOn?'rgba(255,255,255,0.08)':'rgba(255,255,255,0.03)')+';box-shadow:'+(isOn?'0 0 12px '+btn.glow+'44,inset 0 0 8px '+btn.glow+'22':'inset 0 1px 0 rgba(255,255,255,0.05),0 2px 4px rgba(0,0,0,0.25)')+';position:relative;overflow:hidden;min-width:58px;transition:all 0.15s">'
    +'<div style="position:absolute;bottom:-4px;right:-5px;opacity:'+(isOn?0.12:0.03)+';transition:opacity 0.3s;pointer-events:none">'+pawSVG(20,btn.glow)+'</div>'
    +'<div style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;background:linear-gradient(145deg,'+btn.color+','+btn.color+'bb);box-shadow:'+(isOn?'0 0 16px '+btn.glow+'77,0 3px 8px '+btn.color+'55':'0 3px 8px '+btn.color+'44,inset 0 1px 0 rgba(255,255,255,0.2)')+';transition:box-shadow 0.2s">'+btn.emoji+'</div>'
    +'<span style="color:'+(isOn?btn.glow:'rgba(178,210,255,0.6)')+';font-size:7px;font-weight:700;letter-spacing:0.3px;transition:color 0.2s">'+btn.label+'</span>'
    +'</div>';
}

/* === Main Render === */
function render() {
  var gc = state.active ? state.active.glow : '#00ff88';
  var bc = state.active ? state.active.bg : '#0a1628';

  var blipsHTML = '';
  BLIPS.forEach(function(b) {
    blipsHTML += '<div style="position:absolute;top:'+b.top+';left:'+b.left+';animation:pawFlash 5s '+b.delay+'s linear infinite;opacity:0">'+pawSVG(b.size, 'var(--sc)')+'</div>';
  });

  var leftBtns = '', rightBtns = '';
  BTNS_LEFT.forEach(function(b){ leftBtns += btnHTML(b); });
  BTNS_RIGHT.forEach(function(b){ rightBtns += btnHTML(b); });

  var lockColor = state.isLocked ? '#F87171' : 'rgba(148,197,255,0.3)';

  document.getElementById('app').innerHTML = ''
    /* Fullscreen container */
    +'<div id="root" style="--sc:'+gc+';--bc:'+bc+';position:fixed;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#1E3A5F,#172554 50%,#0F1D3A);font-family:Trebuchet MS,sans-serif;overflow:hidden;padding:8px">'

    /* BG Paws */
    +'<div style="position:absolute;top:6%;left:3%;opacity:0.04;animation:pfloat 6s ease-in-out infinite;pointer-events:none">'+pawSVG(45,'#8899bb')+'</div>'
    +'<div style="position:absolute;bottom:6%;right:3%;opacity:0.03;animation:pfloat 8s 2s ease-in-out infinite;pointer-events:none">'+pawSVG(35,'#8899bb')+'</div>'
    +'<div style="position:absolute;top:8%;right:8%;opacity:0.05;pointer-events:none">'+pawSVG(32,'#93C5FD')+'</div>'
    +'<div style="position:absolute;bottom:10%;left:6%;opacity:0.04;pointer-events:none;transform:rotate(-20deg)">'+pawSVG(28,'#93C5FD')+'</div>'

    /* Top bar */
    +'<div style="position:absolute;top:8px;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:6px">'
    +'<div style="width:3px;height:3px;border-radius:50%;background:rgba(100,160,255,0.2)"></div>'
    +'<div style="width:3px;height:3px;border-radius:50%;background:rgba(100,160,255,0.2)"></div>'
    +'<div style="width:3px;height:3px;border-radius:50%;background:rgba(100,160,255,0.2)"></div>'
    +pawSVG(14,'rgba(147,197,253,0.3)')
    +'<div style="width:3px;height:3px;border-radius:50%;background:rgba(100,160,255,0.2)"></div>'
    +'<div style="width:3px;height:3px;border-radius:50%;background:rgba(100,160,255,0.2)"></div>'
    +'<div style="width:3px;height:3px;border-radius:50%;background:rgba(100,160,255,0.2)"></div>'
    +'</div>'

    /* Lock button */
    +'<div id="lockBtn" style="position:absolute;top:6px;right:10px;z-index:50;padding:6px;cursor:pointer;border-radius:8px;background:'+(state.isLocked?'rgba(239,68,68,0.15)':'rgba(255,255,255,0.04)')+';animation:'+(state.isLocked?'lockPulse 2s ease-in-out infinite':'none')+'">'+lockSVG(16,lockColor,state.isLocked)+'</div>'

    /* Main row */
    +'<div style="display:flex;align-items:center;gap:10px;width:100%;max-width:700px;padding:0 4px">'

    /* Left buttons */
    +'<div style="display:flex;flex-direction:column;gap:4px;justify-content:center">'+leftBtns+'</div>'

    /* Center column */
    +'<div style="flex:1;display:flex;flex-direction:column;gap:6px">'
    +'<div style="background:#070D18;border-radius:16px;padding:4px;box-shadow:inset 0 2px 6px rgba(0,0,0,0.7)">'
    +'<div id="radarArea" style="width:100%;padding-bottom:75%;position:relative;border-radius:12px;overflow:hidden;cursor:pointer;touch-action:none">'

    /* Radar content */
    +'<div style="position:absolute;top:0;left:0;right:0;bottom:0;border-radius:14px;overflow:hidden;background:var(--bc);transition:background 0.4s">'
    /* Grid circles */
    +'<div style="position:absolute;top:50%;left:50%;width:25%;height:25%;transform:translate(-50%,-50%);border:1px solid rgba(0,255,136,0.12);border-radius:50%"></div>'
    +'<div style="position:absolute;top:50%;left:50%;width:50%;height:50%;transform:translate(-50%,-50%);border:1px solid rgba(0,255,136,0.12);border-radius:50%"></div>'
    +'<div style="position:absolute;top:50%;left:50%;width:75%;height:75%;transform:translate(-50%,-50%);border:1px solid rgba(0,255,136,0.12);border-radius:50%"></div>'
    +'<div style="position:absolute;top:50%;left:50%;width:98%;height:98%;transform:translate(-50%,-50%);border:1px solid rgba(0,255,136,0.12);border-radius:50%"></div>'
    /* Crosshairs */
    +'<div style="position:absolute;top:50%;left:2%;right:2%;height:1px;background:rgba(0,255,136,0.08)"></div>'
    +'<div style="position:absolute;left:50%;top:2%;bottom:2%;width:1px;background:rgba(0,255,136,0.08)"></div>'
    /* Rotating sweep */
    +'<div style="position:absolute;top:0;left:0;right:0;bottom:0;animation:sweep 5s linear infinite">'
    +'<div style="position:absolute;top:50%;left:50%;width:70%;height:2px;margin-top:-1px;transform-origin:left center;background:var(--sc);box-shadow:0 0 10px var(--sc);z-index:2;transition:all 0.3s"></div>'
    +'<div style="position:absolute;top:0;left:0;right:0;bottom:0;filter:blur(4px)">'+buildSweepLines()+'</div>'
    +'</div>'
    /* Blips */
    +blipsHTML
    /* Touch paw container */
    +'<div id="touchLayer" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:3"></div>'
    /* X marks container */
    +'<div id="xMarkLayer" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:4"></div>'
    /* Center dot */
    +'<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background:var(--sc);box-shadow:0 0 8px var(--sc);transition:all 0.3s"></div>'
    /* Watermark */
    +'<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);opacity:0.035">'+pawSVG(120,'var(--sc)')+'</div>'
    /* Scanlines */
    +'<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.04) 3px,rgba(0,0,0,0.04) 4px);pointer-events:none"></div>'
    +'</div>'

    /* Popup */
    +'<div id="popup" style="display:none;position:absolute;bottom:15%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.82);color:#fff;padding:5px 12px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap;align-items:center;gap:4px;border:1px solid '+gc+'55;animation:fadeUp 0.25s ease-out;z-index:5"></div>'

    +'</div></div>'

    /* Status bar */
    +'<div style="display:flex;justify-content:space-between;align-items:center;padding:0 4px">'
    +'<div style="display:flex;align-items:center;gap:4px">'
    +'<div style="width:6px;height:6px;border-radius:50%;background:'+gc+';box-shadow:0 0 6px '+gc+';transition:all 0.3s"></div>'
    +'<span style="color:rgba(148,197,255,0.55);font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase">'+(state.active?state.active.label:'Ready')+'</span>'
    +'</div>'
    +'<div style="display:flex;gap:2px;align-items:flex-end">'
    +'<div style="width:3px;height:6px;border-radius:1.5px;background:rgba(0,255,136,0.45)"></div>'
    +'<div style="width:3px;height:9px;border-radius:1.5px;background:rgba(0,255,136,0.45)"></div>'
    +'<div style="width:3px;height:12px;border-radius:1.5px;background:rgba(0,255,136,0.45)"></div>'
    +'<div style="width:3px;height:15px;border-radius:1.5px;background:rgba(100,160,255,0.12)"></div>'
    +'</div></div>'
    +'</div>'

    /* Right buttons */
    +'<div style="display:flex;flex-direction:column;gap:4px;justify-content:center">'+rightBtns+'</div>'

    +'</div>'

    /* Bottom accent */
    +'<div style="position:absolute;bottom:6px;left:0;right:0;display:flex;justify-content:center;align-items:center;gap:6px">'
    +'<div style="width:24px;height:2px;border-radius:1px;background:linear-gradient(90deg,transparent,rgba(56,189,248,0.25))"></div>'
    +pawSVG(11,'rgba(56,189,248,0.2)')
    +'<div style="width:24px;height:2px;border-radius:1px;background:linear-gradient(90deg,rgba(56,189,248,0.25),transparent)"></div>'
    +'</div>'

    +'</div>';

  attachEvents();
}

/* === Event Binding === */
function attachEvents() {
  /* Buttons */
  document.querySelectorAll('.pad-btn').forEach(function(el) {
    el.addEventListener('click', function() {
      var id = parseInt(el.dataset.id);
      var btn = BTNS_LEFT.concat(BTNS_RIGHT).find(function(b){return b.id===id});
      if (!btn) return;
      doSound(btn.sound);
      state.pid = btn.id;
      state.active = btn;
      state.pop = btn.msg;
      updateUI();
      clearTimeout(activeTimer);
      activeTimer = setTimeout(function() {
        state.active = null; state.pop = ''; state.pid = -1;
        updateUI();
      }, 2500);
    });
  });

  /* Radar touch */
  var radar = document.getElementById('radarArea');
  if (radar) {
    radar.addEventListener('pointerdown', function(e) {
      var rect = radar.getBoundingClientRect();
      var xPct = ((e.clientX - rect.left) / rect.width) * 100;
      var yPct = ((e.clientY - rect.top) / rect.height) * 100;
      longPressPos = {x: xPct, y: yPct};
      didLongPress = false;
      longPressTimer = setTimeout(function() {
        didLongPress = true;
        spawnX(longPressPos.x, longPressPos.y);
      }, LONG_PRESS_MS);
    });
    radar.addEventListener('pointerup', function(e) {
      clearTimeout(longPressTimer);
      if (!didLongPress) {
        var rect = radar.getBoundingClientRect();
        var xPct = ((e.clientX - rect.left) / rect.width) * 100;
        var yPct = ((e.clientY - rect.top) / rect.height) * 100;
        spawnPaw(xPct, yPct);
      }
    });
    radar.addEventListener('pointerleave', function() {
      clearTimeout(longPressTimer);
    });
  }

  /* Lock button */
  var lockBtn = document.getElementById('lockBtn');
  if (lockBtn) {
    lockBtn.addEventListener('click', function() {
      if (state.isLocked) {
        showPinOverlay('unlock');
      } else {
        showPinOverlay('set');
      }
    });
  }
}

/* === Lightweight UI Update (no full re-render) === */
function updateUI() {
  var gc = state.active ? state.active.glow : '#00ff88';
  var bc = state.active ? state.active.bg : '#0a1628';
  var root = document.getElementById('root');
  if (root) {
    root.style.setProperty('--sc', gc);
    root.style.setProperty('--bc', bc);
  }

  /* Update buttons */
  document.querySelectorAll('.pad-btn').forEach(function(el) {
    var id = parseInt(el.dataset.id);
    var btn = BTNS_LEFT.concat(BTNS_RIGHT).find(function(b){return b.id===id});
    var isOn = state.pid === id;
    el.style.background = isOn ? 'rgba(255,255,255,0.08)' : 'rgba(255,255,255,0.03)';
    el.style.boxShadow = isOn ? '0 0 12px '+btn.glow+'44,inset 0 0 8px '+btn.glow+'22' : 'inset 0 1px 0 rgba(255,255,255,0.05),0 2px 4px rgba(0,0,0,0.25)';
  });

  /* Popup */
  var popup = document.getElementById('popup');
  if (popup) {
    if (state.pop) {
      popup.style.display = 'flex';
      popup.style.borderColor = gc + '55';
      popup.innerHTML = pawSVG(9, gc) + '<span>' + state.pop + '</span>';
    } else {
      popup.style.display = 'none';
    }
  }
}

/* === Spawn Touch Paw === */
function spawnPaw(x, y) {
  var layer = document.getElementById('touchLayer');
  if (!layer) return;
  var gc = state.active ? state.active.glow : '#00ff88';
  var el = document.createElement('div');
  el.style.cssText = 'position:absolute;left:'+x+'%;top:'+y+'%;transform:translate(-50%,-50%);animation:pawPop 2s ease-out forwards;pointer-events:none';
  el.innerHTML = pawSVG(40, gc);
  layer.appendChild(el);
  setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 2100);
}

/* === Spawn X Mark === */
function spawnX(x, y) {
  var layer = document.getElementById('xMarkLayer');
  if (!layer) return;
  var el = document.createElement('div');
  el.style.cssText = 'position:absolute;left:'+x+'%;top:'+y+'%;transform:translate(-50%,-50%);animation:xGrow 4s ease-out forwards;pointer-events:none;filter:drop-shadow(0 0 6px #CC2222) drop-shadow(0 0 12px #AA000088)';
  el.innerHTML = xSVG(66, '#DD2222');
  layer.appendChild(el);
  setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 4100);
}

/* === Fullscreen === */
function goFullscreen() {
  var el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}
function exitFullscreen() {
  if (document.exitFullscreen) document.exitFullscreen();
  else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
}

/* === PIN Overlay === */
function showPinOverlay(mode) {
  var entry = '', confirm = '', step = 'enter', error = '';

  function getTitle() {
    if (mode === 'set') return step === 'enter' ? 'Set a 4-digit PIN' : 'Confirm your PIN';
    return 'Enter PIN to unlock';
  }

  function renderDots(val) {
    var h = '';
    for (var i = 0; i < 4; i++) {
      var filled = i < val.length;
      h += '<div style="width:16px;height:16px;border-radius:50%;background:'+(filled?'#60A5FA':'transparent')+';border:2px solid '+(filled?'#60A5FA':'rgba(148,197,255,0.3)')+';box-shadow:'+(filled?'0 0 8px #60A5FA66':'none')+';transition:all 0.15s"></div>';
    }
    return h;
  }

  function buildOverlay() {
    var currentVal = step === 'confirm' ? confirm : entry;
    var overlay = document.getElementById('pinOverlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'pinOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;z-index:100;font-family:Trebuchet MS,sans-serif';
      document.body.appendChild(overlay);
    }
    overlay.innerHTML = '<div style="background:linear-gradient(180deg,#1a2a4a,#0f1d3a);border-radius:24px;padding:24px 28px;width:280px;box-shadow:0 0 0 2px rgba(37,99,235,0.2),0 20px 40px rgba(0,0,0,0.6);display:flex;flex-direction:column;align-items:center;gap:16px">'
      +'<div style="display:flex;align-items:center;gap:8px">'+lockSVG(20,'#60A5FA',mode==='unlock')+'<span style="color:#93C5FD;font-size:14px;font-weight:700">'+getTitle()+'</span></div>'
      +(error ? '<span style="color:#F87171;font-size:11px;font-weight:600">'+error+'</span>' : '')
      +'<div style="display:flex;gap:12px">'+renderDots(currentVal)+'</div>'
      +'<div id="pinPad" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%"></div>'
      +'<div id="pinCancel" style="color:rgba(148,197,255,0.45);font-size:11px;font-weight:600;cursor:pointer;padding:4px 12px">Cancel</div>'
      +'</div>';

    var pad = document.getElementById('pinPad');
    ['1','2','3','4','5','6','7','8','9','','0','del'].forEach(function(k) {
      if (k === '') { var sp = document.createElement('div'); pad.appendChild(sp); return; }
      var isDel = k === 'del';
      var btn = document.createElement('div');
      btn.textContent = isDel ? 'DEL' : k;
      btn.style.cssText = 'display:flex;align-items:center;justify-content:center;height:44px;border-radius:10px;cursor:pointer;background:'+(isDel?'rgba(239,68,68,0.15)':'rgba(255,255,255,0.06)')+';color:'+(isDel?'#F87171':'#CBD5E1')+';font-size:'+(isDel?'12':'18')+'px;font-weight:700;box-shadow:inset 0 1px 0 rgba(255,255,255,0.05),0 2px 4px rgba(0,0,0,0.3)';
      btn.addEventListener('click', function() {
        doSound('keyTap');
        if (isDel) {
          if (step === 'confirm') confirm = confirm.slice(0,-1);
          else entry = entry.slice(0,-1);
          error = '';
          buildOverlay();
          return;
        }
        if (step === 'confirm') {
          if (confirm.length >= 4) return;
          confirm += k;
          if (confirm.length === 4) {
            if (confirm === entry) { closePinOverlay(); onPinComplete(confirm); }
            else { doSound('error'); error = "PINs don't match. Try again."; entry = ''; confirm = ''; step = 'enter'; }
          }
        } else {
          if (entry.length >= 4) return;
          entry += k;
          if (entry.length === 4) {
            if (mode === 'set') { step = 'confirm'; }
            else { closePinOverlay(); onPinComplete(entry); }
          }
        }
        buildOverlay();
      });
      pad.appendChild(btn);
    });

    document.getElementById('pinCancel').addEventListener('click', closePinOverlay);
  }

  function onPinComplete(pin) {
    if (mode === 'set') {
      state.storedPin = pin;
      state.isLocked = true;
      doSound('lock');
      goFullscreen();
      render();
    } else {
      if (pin === state.storedPin) {
        state.isLocked = false;
        state.storedPin = null;
        doSound('unlock');
        exitFullscreen();
        render();
      } else {
        doSound('error');
        render();
      }
    }
  }

  buildOverlay();
}

function closePinOverlay() {
  var overlay = document.getElementById('pinOverlay');
  if (overlay) overlay.parentNode.removeChild(overlay);
}

/* === Init === */
render();

/* === Register Service Worker === */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(function(e) { console.log('SW registration failed:', e); });
}
</script>
</body>
</html>
